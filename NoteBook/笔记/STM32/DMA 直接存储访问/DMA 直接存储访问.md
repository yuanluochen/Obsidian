# DMA 直接存储访问

DMA(Direct memory access)可实现在无cpu的参与下实现外设或存储器与存储器之间直接数据传输

存储器与存储器之间数据转运，一般软件触发，外设与存储器之间数据转运，一般硬件触发。

## 存储器

ROM，只读存储器，非易失性，数据掉电不丢失，该类型的存储器在stm32中有三种

1. 主闪存flash：此存储器是存储代码的位置
2. 系统存储器：用于串口下载
3. 选项字节：用于存储一些独立与程序代码的配置参数

RAM：随机存储器，数据掉电丢失

1. 运行内存SRAM：类似电脑内存条
2. 外设寄存器
3. 内核外设寄存器

寄存器本质上是存储器，更改访问寄存器数值本质上，可以理解为将一个数据从一个地址写入该寄存器的地址。

## DMA结构

每一个DMA外设内部都有多路DMA通道，多路DMA通道最终进入DMA总线发送到目标地址

在STM32芯片之中DMA总线与CPU系统总线会在一个仲裁器内相遇，此仲裁器发生作用是，在DMA与CPU访问同一个目标时。仲裁器会暂停CPU访问该目标地址，让DMA先访问。DMA访问完毕后，CPU再访问该目标。

DMA作为一个外设，向其他外设一样也拥有自己的配置寄存器。DMA是总线矩阵的主动单元，可以读写各种寄存器，也是AHB总线的被动单元，会被各种主动单元读取，所以CPU可以通过AHB总线访问DMA的寄存器，对其进行配置。

DMA请求，DMA的硬件触发源，各种外设通过DMA请求触发DMA数据转运
。

由于flash是ROM的一种，是一种只读存储器。若DMA的数据转运地址为flash，则DMA仅可读取flash数据，不可将数据写入flash。

==注意：DMA仅可进行外设到存储器，存储器到存储器的数据转运。不可进行Flash到SRAM之间的数据转运==

## DMA配置

DMA数据转运配置要配置发送端接收端起始地址，数据宽度，地址是否自增。数据宽度可为uint8_t,uint16_t,uint32_t。地址是否自增的作用为一次数据转运后地址是否改变。在存储器，地址是否自增，若自增，每转运一个数据，地址就要改变一下，例如接收数据，该参数设置为自增，则会防止，数据覆盖。

在配置DMA时要配置DMA转运数据的两端地址。要传输的数据宽度，以及转运地址是否自增

传输计数器，配置传输次数，每传输一次传输计数器减一。在传输计数器，一侧有自动重装载器，配置此项设定在传输计数器数值为零时，是否进行重装载，回复到初始值

DMA的触发控制，其触发可配置为通过配置M2M来选择是要通过硬件触发，还是通过软件触发。当M2M为1时，DMA配置为软件触发，当M2M(memory to memory)为0时，DMA配置为硬件触发。软件触发时传输计数器快速清零，不应该将软件触发与自动重装载同时配置。**软件触发一般适用于存储器到存储器之间的访问**

DMA数据转运的条件

1. DMA必须使能
2. 传输计数器必须不为0
3. 有触发

若传输计数器为0，且未配置自动重装载器，DMA就会停止数据转运。这时，就要让DMA处于DISABLED的状态，重新配置传输计数器的数值，然后ENABLE DMA，这样才可使DMA再次驱动。

注意==DMA在ENABLE状态下其传输计数器不可配置，只有其在DISABLE状态下才可被配置==

DMA请求，每一个DMA通道都有软硬件触发选项。M2M是软硬件控制位。若使用硬件触发，由于每一个硬件触发都有特殊的DMA通道，它不同于软件触发，可以随意选择任意通道，要使用硬件触发，要选择对应的DMA通道，要使用特定的硬件触发，不仅要选择对应DMA通道，还要ENABLE对应的硬件触发。可以同时开启同一通道的多个硬件触发源。但一般不建议。

同一DMA内部，多通道DMA最终进入仲裁器，通过DMA优先级判断，最终产生该DMA的请求。默认优先级通道号越小优先级越高。也可自己配置优先级。

当两端数据宽度不同，源端目标数据宽度相同时，源端读一位，目标写一位，一一对应。目标数据宽度大于源端宽度，则在目标数据前侧多出来的部分补0，若源端数据宽度大于目标数据宽度，则舍弃高位数据，保留低位。
