# 定时器

- 定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断。
- 16位计数器，预分频器，自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65的定时
- 不仅具备基本的定时器中断功能，而且包含内外时钟源选择，输入捕获，输出比较，编码器接口，主从触发模式等多种功能选择

| 类型       | 编号                   | 总线 | 功能                                                                                               |
| ---------- | ---------------------- | ---- | -------------------------------------------------------------------------------------------------- |
| 高级定时器 | TIM1、TIM8             | APB2 | 具有通用定时器的全部功能，并额外具有重复计数器、死区生成、互补输出、刹车输入                       |
| 通用定时器 | TIM2、TIM3、TIM4、TIM5 | APB1 | 拥有基本定时器的全部功能，并额外具有内外时钟源的选择、输入捕获、输出比较、编码器接口、主从触发模式 |
| 基本定时器 | TIM6、TIM7             | APB1 | 拥有定时中断，主模式触发DAC的功能                                                                  |

## 基本定时器

时基单元：PSC预分频器，CNT计数器，自动重装载寄存器。以高级定时器为例，其可选择内部时钟源168MHz，预分频器PSC，对APB2总线频率进行分频，若PSC为1，则为2分频，则接入频率为84MHz，同理若PSC为2，则为三分频，输出=输入/3。

然后是计数器，对预分频后的计数时钟进行计数。该计数器为16位计数器，计数器的值可以从0一直加到65535，如果再加，计数器会变为0，计数器的值在计数过程中会不断自增运行，当自增运行到目标值时，会产生中断，此时就完成了定时的任务

自动重装寄存器，存储计数目标的寄存器。当计数值等于自动重装载寄存器数值，那其就会产生一个中断信号，并且清零计数器。计数器自动开始下一次的计数器计时，计数值等于自动重装载值产生的中断，一般称为更新中断。这个更新中断之后就会通往NVIC，我们再配置好定时器的更新中断，定时器的更新中断就会得到CPU的响应

主模式触发DAC，在使用DAC时我们可能需要DAC发出一段波形，那就需要每隔一段时间触发一次DAC，让它输出下一个电压点，如果想要实现上述要求，那么我们就要先设置一个定时器产生中断，每隔一段时间在中断程序中调用代码，手动触发一次DAC转换，然后DAC输出，但是这样会使主程序频繁处于中断的状态，这会影响定时器的运行，所以定时器就设置了一个主模式，这个主模式，就可以把定时器的更新事件映射到触发输出TRGO（Trigger Out)的位置。TRGO直接接到DAC的触发转换引脚，直接对其触发，不需要中断参与。

## 通用定时器

对于通用定时器，和高级定时器不同于基本定时器，不仅可以实现向上计数，还可以实现，向下计数，和中央对齐模式。向下计数模式是从重装值开始，向下自减。减到零之后，回到重装值同时申请中断。

通用定时器，不仅可以选择内部时钟源（HSE 168MHz)，也可选择外部时钟源。
TIMx_ETR引脚上的外部时钟。若外部电路通过ETR引脚输入信号，信号经历
处理整形，分为两路输出，一路进入ETRF进入触发控制器，之后就可已选择作为时基单元的时钟，若想对ETR进行计数，把这个定时器当作计数器来用，那就可以配置这一路的的电路，在STM32中这一路也叫做**外部时钟模式2**

计数器计数频率

$$
CK__CNT = CK__PSC/(PSC + 1)
$$

计数器溢出频率

$$
CK_CNT_OV = CK_CNT/(ARR + 1) = CK_PSC/(PSC + 1)/(ARR + 1)
$$

溢出时间

$$
T = (PSC + 1)/84MHZ * (ARR + 1)
$$
